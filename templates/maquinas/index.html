{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Máquinas</h1>
  <div>
    <a href="{{ url_for('monitor.new_machine') }}" class="btn btn-primary me-2">➕ Nueva máquina</a>
    <a href="{{ url_for('monitor.dashboard') }}" class="btn btn-secondary">Volver</a>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Monitorea / Piezas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for machine in machines %}
          {# Obtener estado con fallback #}
          {% set status = (machine.get('status') if machine.get('status') else (machine.get('estado') if machine.get('estado') else 'Sin datos')) %}
          {# Badge según estado #}
          {% if status == 'Activo' %}
            {% set badge = 'success' %}
          {% elif status == 'Inactivo' %}
            {% set badge = 'secondary' %}
          {% elif status == 'Mantenimiento' %}
            {% set badge = 'warning' %}
          {% else %}
            {% set badge = 'dark' %}
          {% endif %}

          {# Obtener piezas asociadas si vienen en el objeto (keys 'pieces' o 'piezas') #}
          {% set piezas = machine.get('pieces') if machine.get('pieces') is not none else (machine.get('piezas') if machine.get('piezas') is not none else []) %}

          <tr>
            <td>{{ machine.get('id') }}</td>
            <td>{{ machine.get('name') or machine.get('nombre') or 'Sin nombre' }}</td>
            <td><span class="badge bg-{{ badge }}">{{ status }}</span></td>
            <td>
              {% if piezas|length > 0 %}
                <ul class="mb-0">
                  {% for p in piezas %}
                    <li>
                      {{ p.get('nombre') or p.get('name') or 'pieza sin nombre' }}
                      {% if p.get('estado') %}
                        <span class="badge bg-info text-dark ms-2">{{ p.get('estado') }}</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted">Sin piezas</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('monitor.edit_machine', machine_id=machine.get('id')) }}" class="btn btn-sm btn-warning">Editar</a>

              <form action="{{ url_for('monitor.delete_machine', machine_id=machine.get('id')) }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
              </form>

              <a href="{{ url_for('piezas.index', machine_id=machine.get('id')) }}" class="btn btn-sm btn-info ms-1">
                Piezas <span class="badge bg-light text-dark ms-1">{{ piezas|length }}</span>
              </a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
